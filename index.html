
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODULO PRENOTAZIONE LOCALIZZATORI</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: Roboto, Arial, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; background: #e6f0fa; font-size: 16px; }
  #formWrapper { width: 100%; max-width: 480px; padding: 10px 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); margin: 20px auto; }
  h2 { text-align: center; font-size: 22px; margin-bottom: 10px; }
  h4 { text-align: center; font-size: 16px; color: #555; margin: 5px 0; font-weight: normal; }
  label { display: block; font-weight: bold; margin-top: 18px; font-size: 16px; text-align: center; }
  input, select { width: 100%; padding: 16px 14px; margin-top: 5px; font-size: 20px; border-radius: 8px; border: 1px solid #ccc; display: block; text-align: center; }
  
  /* Gestione Step */
  .step-container { display: none; }
  .step-active { display: block; animation: fadeIn 0.5s; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
  button { flex: 1; background-color: #1a73e8; color: white; border: none; cursor: pointer; font-size: 20px; padding: 18px; border-radius: 8px; font-weight: bold; transition: all 0.3s; }
  button:hover:not(:disabled) { background: #1557b0; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  .btn-indietro { background-color: #6c757d !important; }
  
  .bottoni-tipo { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
  .bottoni-tipo button { background-color: #ccc; font-size: 16px; height: 70px; }
  .bottoni-tipo button.selezionato { background-color: #1a73e8; border: 2px solid #000; }
  
  #infoRiconsegna { background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 8px; font-weight: bold; color: #856404; text-align: center; display: none; }
  .avviso-importante { background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin: 20px 0; font-size: 14px; line-height: 1.6; color: #856404; text-align: center; }
  .avviso-importante strong { display: block; font-size: 16px; margin-bottom: 8px; color: #000; }
  
  #loadingOverlay, #sendingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #e6f0fa; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; }
  .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #1a73e8; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body onload="init()">

<div id="loadingOverlay"><div class="spinner"></div><p>Caricamento modulo in corso...</p></div>
<div id="sendingOverlay" style="display:none;"><div class="spinner"></div><p id="sendingText">Invio in corso...</p></div>

<div id="formWrapper" style="display:none;">
  <h2>PRENOTAZIONE APPUNTAMENTO LOCALIZZATORE SATELLITARE ASSICURATIVO o MOVE-IN</h2>
  <h4>PALAMINI AUTO, Via San Luigi 1/A, Cesano Maderno</h4>

  <form id="prenotaForm" onsubmit="return false;">
    
    <div id="step1" class="step-container step-active">
      <label>SU QUALE LOCALIZZATORE DEVI EFFETTUARE LA LAVORAZIONE?</label>
      <div class="bottoni-tipo">
        <button type="button" id="btnAssicurativo" onclick="selezionaTipo('assicurativo')">ASSICURATIVO</button>
        <button type="button" id="btnMoveIn" onclick="selezionaTipo('movein')">MOVE-IN<br>(regione lombardia)</button>
      </div>
    </div>

    <div id="step2" class="step-container">
      <label>EMAIL:</label><input type="email" id="email" oninput="aggiornaStatoPrenota()">
      <label>TARGA AUTO:</label><input type="text" id="targa" maxlength="7" style="text-transform:uppercase;" oninput="aggiornaStatoPrenota()">
      <label>NOME E COGNOME ASSICURATO:</label><input type="text" id="nomeCognome" oninput="aggiornaStatoPrenota()">
      <label>CONTATTO TELEFONICO:</label><input type="text" id="telefono" oninput="aggiornaStatoPrenota()">
      <label>NOME COMPAGNIA ASSICURATIVA o PROVIDER MOVE-IN</label>
      <select id="compagnia" onchange="aggiornaStatoPrenota()"></select>
      <div class="nav-buttons">
        <button type="button" class="btn-indietro" onclick="changeStep(-1)">Indietro</button>
        <button type="button" onclick="changeStep(1)">Avanti</button>
      </div>
    </div>

    <div id="step3" class="step-container">
      <div class="avviso-importante">
        <strong>IMPORTANTE DA LEGGERE!</strong>
        Per gli smontaggi: munirsi TASSATIVAMENTE del foglio di installazione per conoscere la posizione del localizzatore all'interno dell'auto (NON serve se si conosce l'ESATTA posizione del localizzatore all'interno dell'auto).
        <br><br>ATTENZIONE: L'abitacolo e il baule del veicolo devono essere PULITI e PRIVI di oggetti personali.<br><br>
        NON prenotare tramite questo modulo la SOLA consegna o la riconsegna del localizzatore (ConTe, BeRebel), è sufficiente passare in officina dal lunedì al venerdì 9:00 - 12:15 e 14:30 - 17:30 per il ritiro senza appuntamento. Prenotare solo se si desidera la lavorazione di montaggio o smontaggio.
      </div>
      <div class="nav-buttons">
        <button type="button" class="btn-indietro" onclick="changeStep(-1)">Indietro</button>
        <button type="button" onclick="changeStep(1)">HO LETTO, AVANTI</button>
      </div>
    </div>

    <div id="step4" class="step-container">
      <label>LAVORAZIONE RICHIESTA</label>
      <select id="lavorazione" onchange="aggiornaVisibilita()">
        <option value="" selected disabled>Seleziona...</option>
        <option value="montaggio">MONTAGGIO (massimo 50 minuti di fermo auto)</option>
        <option value="smontaggio">SMONTAGGIO (massimo 50 minuti di fermo auto)</option>
        <option value="smontmont">SMONTAGGIO + MONTAGGIO (massimo 1,5 ora di fermo auto)</option>
        <option value="anomalia">ANOMALIA-GUASTO-VERIFICA LOCALIZZATORE (massimo 3 ore di fermo auto)</option>
        <option value="annullamento">ANNULLAMENTO APPUNTAMENTO</option>
      </select>

      <label id="labelNoteCliente">EVENTUALI NOTE CLIENTE:</label>
      <input type="text" id="notecliente" oninput="aggiornaStatoPrenota()">
      
      <div id="wrapperData" style="display:none;">
        <label>DATA APPUNTAMENTO:</label>
        <select id="dataAppuntamento" onchange="aggiornaRiconsegna()"></select>
      </div>

      <div id="infoRiconsegna"></div>

      <div style="background:#ffe6e6; border:2px solid red; border-radius:8px; padding:12px; margin-top:15px; color:red; font-weight:bold; font-size:15px; text-align:center;">
        ⏰ Si raccomanda di rispettare l'orario prescelto. Con un ritardo superiore ai 10 minuti l'appuntamento verrà considerato annullato.
      </div>

      <div class="nav-buttons">
        <button type="button" class="btn-indietro" onclick="changeStep(-1)">Indietro</button>
        <button type="button" id="btnPrenota" onclick="verificaEinvia()">Prenota</button>
      </div>
    </div>
  </form>
</div>

<div id="successOverlay" style="display:none; text-align:center; padding:40px; color:#2e7d32; border:3px solid #4caf50; background:#fff; margin:20px; border-radius:12px;">
  <h2>✅ MODULO INVIATO CORRETTAMENTE</h2>
  <p>Si ricorda che è obbligatorio presentarsi in officina il giorno dell'appuntamento con la mail appena ricevuta (controllare anche lo SPAM).</p>
</div>

<script>
const COMPAGNIE_ASSICURATIVE = ["Unipol", "Linear", "Arca", "BeRebel (costo a carico cliente di 18,30€)", "Groupama", "Generali (prendere appuntamento 7gg dopo emissione polizza)", "Genertel-Jeniot (prendere appuntamento 7gg dopo emissione polizza)", "Cattolica (prendere appuntamento 7gg dopo emissione polizza)", "Tua Assicurazioni", "IntesaSanPaolo", "Allianz", "ConTe-Octo Telematics (costo a carico cliente di 12,20€)", "Sara Assicurazioni", "Italiana Assicurazioni", "Vodafone", "Reale Mutua", "ALTRO: Inserire nome compagnia assicurativa nel campo NOTE CLIENTE"];
const COMPAGNIE_MOVEIN = ["MoveIN-Viasat (prendere appuntamento 7gg dopo il pagamento a Viasat)", "MoveIN-Octo Telematics", "MoveIN-Unipol (prendere appuntamento tra almeno 10gg)"];
const API_URL = 'https://script.google.com/macros/s/AKfycbwoC5ZEaTAGQru63oUO8DyD0Y20bP5hblqtjFG8CWjudmPM5TfcFZsExi6rs4qyeEsR/exec';

let currentStep = 1;
let tipoLocalizzatoreSelezionato = null;
let dateDisponibiliMontaggio = [];
let dateDisponibiliAnomalia = [];

async function init() {
  try {
    const response = await fetch(API_URL + '?action=getAllData');
    const data = await response.json();
    dateDisponibiliMontaggio = data.dateMontaggio || [];
    dateDisponibiliAnomalia = data.dateAnomalia || [];
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('formWrapper').style.display = 'block';
  } catch (e) { alert("Errore caricamento date. Riprova."); }
}

function selezionaTipo(tipo) {
  tipoLocalizzatoreSelezionato = tipo;
  document.getElementById("btnAssicurativo").className = tipo === 'assicurativo' ? 'selezionato' : '';
  document.getElementById("btnMoveIn").className = tipo === 'movein' ? 'selezionato' : '';
  
  const sel = document.getElementById("compagnia");
  sel.innerHTML = '<option value="" disabled selected>Seleziona...</option>';
  const lista = tipo === 'assicurativo' ? COMPAGNIE_ASSICURATIVE : COMPAGNIE_MOVEIN;
  lista.forEach(c => { let o = document.createElement("option"); o.value = c; o.text = c; sel.add(o); });
  changeStep(1);
}

function changeStep(n) {
  if (n > 0 && !validaCampiStep()) return;
  document.getElementById(`step${currentStep}`).style.display = 'none';
  currentStep += n;
  document.getElementById(`step${currentStep}`).classList.add('step-active');
  document.getElementById(`step${currentStep}`).style.display = 'block';
  window.scrollTo(0,0);
}

function validaCampiStep() {
  if (currentStep === 2) {
    const campi = ["email", "targa", "nomeCognome", "telefono", "compagnia"];
    for(let id of campi) if(!document.getElementById(id).value.trim()) { alert("Attenzione: tutti i campi sono obbligatori"); return false; }
  }
  return true;
}

function aggiornaVisibilita() {
  const lav = document.getElementById("lavorazione").value;
  const wrap = document.getElementById("wrapperData");
  const selData = document.getElementById("dataAppuntamento");
  const labelNote = document.getElementById("labelNoteCliente");

  labelNote.textContent = lav === "smontmont" ? "SCRIVERE ENTRAMBE COMPAGNIE ASSICURATIVE QUA:" : (lav === "annullamento" ? "DATA E ORA DELL'APPUNTAMENTO DA ANNULLARE:" : "EVENTUALI NOTE CLIENTE:");
  
  if (lav && lav !== "annullamento") {
    wrap.style.display = "block";
    let base = lav === "anomalia" ? dateDisponibiliAnomalia : dateDisponibiliMontaggio;
    
    // LOGICA DATE: No oggi, domani solo se smontaggio
    const oggi = new Date();
    const domani = new Date(); domani.setDate(oggi.getDate() + 1);
    const sOggi = oggi.getDate().toString().padStart(2,'0') + "/" + (oggi.getMonth()+1).toString().padStart(2,'0');
    const sDomani = domani.getDate().toString().padStart(2,'0') + "/" + (domani.getMonth()+1).toString().padStart(2,'0');

    const filtrate = base.filter(d => {
      if (d.includes(sOggi)) return false;
      if (d.includes(sDomani)) return lav === "smontaggio";
      return true;
    });

    selData.innerHTML = '<option value="" disabled selected>Seleziona...</option>';
    filtrate.forEach(d => { let o = document.createElement("option"); o.value = d; o.text = d; selData.add(o); });
  } else {
    wrap.style.display = "none";
    selData.value = "";
  }
  aggiornaRiconsegna();
  aggiornaStatoPrenota();
}

function aggiornaRiconsegna() {
  const dataTxt = document.getElementById("dataAppuntamento").value;
  const lav = document.getElementById("lavorazione").value;
  const info = document.getElementById("infoRiconsegna");
  if (!dataTxt || !lav || lav === "annullamento") { info.style.display = "none"; return; }

  const durate = { montaggio: 50, smontaggio: 50, smontmont: 90, anomalia: 180 };
  const match = dataTxt.match(/(\d{2}):(\d{2})/);
  if (match) {
    let h = parseInt(match[1]), m = parseInt(match[2]) + durate[lav];
    while (m >= 60) { m -= 60; h += 1; }
    const nuovaOra = h.toString().padStart(2,'0') + ":" + m.toString().padStart(2,'0');
    info.innerHTML = "data di riconsegna del veicolo stimata: " + dataTxt.replace(/\d{2}:\d{2}/, nuovaOra);
    info.style.display = "block";
  }
  aggiornaStatoPrenota();
}

function aggiornaStatoPrenota() {
  const btn = document.getElementById("btnPrenota");
  const lav = document.getElementById("lavorazione").value;
  const note = document.getElementById("notecliente").value.trim();
  const data = document.getElementById("dataAppuntamento").value;
  
  let ok = (lav !== "");
  if (lav === "annullamento" || lav === "smontmont") ok = ok && note !== "";
  if (lav && lav !== "annullamento") ok = ok && data !== "";
  
  btn.disabled = !ok;
}

async function verificaEinvia() {
  const lav = document.getElementById("lavorazione").value;
  const note = document.getElementById("notecliente").value.trim();
  const dataScelta = document.getElementById("dataAppuntamento").value;

  document.getElementById("sendingText").innerHTML = "Verifica disponibilità data...<br>Attendere...";
  document.getElementById("sendingOverlay").style.display = "flex";

  try {
    // DOPPIO CONTROLLO SICUREZZA
    const response = await fetch(API_URL + '?action=getAllData');
    const checkData = await response.json();
    const dateAttuali = lav === "anomalia" ? checkData.dateAnomalia : checkData.dateMontaggio;

    if (lav !== "annullamento" && !dateAttuali.includes(dataScelta)) {
      document.getElementById("sendingOverlay").style.display = "none";
      alert("⚠️ DATA OCCUPATA: La data scelta è stata appena prenotata. Seleziona un altro orario.");
      dateDisponibiliMontaggio = checkData.dateMontaggio;
      dateDisponibiliAnomalia = checkData.dateAnomalia;
      aggiornaVisibilita();
      return;
    }

    // INVIO EFFETTIVO
    document.getElementById("sendingText").innerHTML = "Invio dati in corso...<br>NON CHIUDERE LA PAGINA";
    const payload = {
      email: document.getElementById("email").value.trim(),
      targa: document.getElementById("targa").value.trim().toUpperCase(),
      nomeCognome: document.getElementById("nomeCognome").value.trim(),
      telefono: document.getElementById("telefono").value.trim(),
      compagnia: document.getElementById("compagnia").value,
      lavorazione: lav,
      notecliente: note,
      dataAppuntamento: dataScelta
    };

    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'salvaPrenotazione', dati: payload }) });
    const result = await res.json();

    if (result.success) {
      document.getElementById("formWrapper").style.display = "none";
      document.getElementById("successOverlay").style.display = "block";
    } else {
      alert("Errore: " + result.error);
    }
  } catch (e) {
    alert("Errore di connessione. Riprova.");
  } finally {
    document.getElementById("sendingOverlay").style.display = "none";
  }
}
</script>
</body>
</html>
